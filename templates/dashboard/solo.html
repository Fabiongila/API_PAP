{% extends "base.html" %}

{% block title %}Solo - AgroCaua{% endblock %}

{% block page_title %}Monitoramento de Solo{% endblock %}
{% block page_icon %}<i class="icon-sprout text-amber-600"></i>{% endblock %}
{% block page_subtitle %}An√°lise detalhada de humidade do solo e recomenda√ß√µes agr√≠colas inteligentes{% endblock %}

{% block content %}
<!-- Main KPI - Soil Humidity Overview - Two Card Layout -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Card 1: Humidity Display -->
    <div class="card bg-gradient-to-br from-amber-50 via-white to-amber-50/30 border border-amber-100 hover:shadow-xl transition-all duration-500">
        <p class="text-sm font-600 text-gray-500 uppercase tracking-widest mb-6">Humidade Atual do Solo</p>
        <div class="flex flex-col gap-6">
            <div class="flex items-baseline gap-3">
                <p class="text-5xl font-bold bg-gradient-to-r from-amber-600 to-amber-500 bg-clip-text text-transparent" id="soilValue">--%</p>
                <span class="text-xs font-600 text-amber-600 bg-amber-100 px-3 py-1.5 rounded-full" id="humidityLevel">--</span>
            </div>
            
            <div class="text-xs text-gray-600 font-500">
                <span>M√≠nimo: <span id="soilMin" class="font-bold text-gray-900">--%</span></span>
            </div>
        </div>
    </div>

    <!-- Card 2: Recommendation & Status -->
    <div class="card bg-gradient-to-br from-white to-gray-50 border border-gray-100 hover:shadow-xl transition-all duration-500 flex flex-col justify-between">
        <div>
            <p class="text-xs font-600 text-gray-500 uppercase tracking-widest mb-4">Recomenda√ß√£o</p>
            <p class="text-3xl font-bold text-gray-900 mb-4" id="soilRecommendation">--</p>
            <p class="text-sm text-gray-600 leading-relaxed" id="soilAction">Recomenda√ß√£o: --</p>
        </div>
        <div id="statusBadge" class="mt-6">
            <span class="badge badge-success">Analisando...</span>
        </div>
    </div>
</div>

<!-- Key Metrics Grid -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Soil Health Score -->
    <div class="card bg-gradient-to-br from-purple-50 to-white border border-purple-100 hover:shadow-lg transition-all duration-500 group">
        <div class="flex items-start gap-3 mb-4">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform">
                <i class="icon-heart text-purple-600 text-lg"></i>
            </div>
            <div>
                <p class="text-xs font-600 text-gray-500 uppercase tracking-widest">Sa√∫de do Solo</p>
            </div>
        </div>
        <p class="text-4xl font-bold text-purple-600 mb-3" id="healthScore">--</p>
        <div class="w-full bg-gray-200/50 rounded-full h-2 overflow-hidden mb-3">
            <div id="healthBar" class="bg-gradient-to-r from-purple-400 to-purple-600 h-full rounded-full transition-all duration-700" style="width: 0%"></div>
        </div>
        <p class="text-xs text-gray-600 font-500" id="healthStatus">Analisando...</p>
    </div>

    <!-- Risk Assessment -->
    <div class="card bg-gradient-to-br from-orange-50 to-white border border-orange-100 hover:shadow-lg transition-all duration-500 group">
        <div class="flex items-start gap-3 mb-4">
            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform">
                <i class="icon-alert-circle text-orange-600 text-lg"></i>
            </div>
            <div>
                <p class="text-xs font-600 text-gray-500 uppercase tracking-widest">N√≠vel de Risco</p>
            </div>
        </div>
        <p class="text-4xl font-bold text-orange-600 mb-3" id="riskLevel">--</p>
        <p class="text-sm text-gray-700 font-500 mb-3" id="riskDescription">Analisando condi√ß√µes...</p>
        <div id="riskBadge"></div>
    </div>

    <!-- Statistics -->
    <div class="card bg-gradient-to-br from-blue-50 to-white border border-blue-100 hover:shadow-lg transition-all duration-500 group">
        <div class="flex items-start gap-3 mb-4">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform">
                <i class="icon-bar-chart text-blue-600 text-lg"></i>
            </div>
            <div>
                <p class="text-xs font-600 text-gray-500 uppercase tracking-widest">Estat√≠sticas</p>
            </div>
        </div>
        <div class="space-y-3">
            <div>
                <p class="text-xs text-gray-600 font-500 mb-1">M√©dia</p>
                <p class="text-2xl font-bold text-blue-600" id="avgHumidity">--%</p>
            </div>
            <div>
                <p class="text-xs text-gray-600 font-500 mb-1">Varia√ß√£o</p>
                <p class="text-2xl font-bold text-blue-600" id="variationHumidity">--%</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Humidity Trend Chart -->
    <div class="lg:col-span-2 card chart-container bg-gradient-to-br from-gray-50/50 to-white border border-gray-100 hover:shadow-xl transition-all duration-500">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                <i class="icon-trending-up text-amber-600"></i>
                Evolu√ß√£o da Humidade
            </h3>
            <span class="text-xs font-500 text-gray-500 bg-gray-100 px-3 py-1 rounded-full">√öltimas 24h</span>
        </div>
        <div class="chart-wrapper">
            <canvas id="soilChart"></canvas>
        </div>
    </div>

    <!-- Ideal Range Reference -->
    <div class="card bg-gradient-to-br from-green-50 to-white border border-green-100 hover:shadow-lg transition-all duration-500">
        <h3 class="text-lg font-semibold text-gray-900 mb-5 flex items-center gap-2">
            <i class="icon-info text-green-600"></i>
            Gama Ideal
        </h3>
        <div class="space-y-3">
            <div class="p-4 bg-green-100/30 border border-green-200/60 rounded-[10px]">
                <p class="text-xs font-700 text-green-900 uppercase tracking-wider mb-1">Zona √ìtima</p>
                <p class="text-xl font-bold text-green-700">40 - 60%</p>
            </div>
            <div class="p-4 bg-yellow-100/30 border border-yellow-200/60 rounded-[10px]">
                <p class="text-xs font-700 text-yellow-900 uppercase tracking-wider mb-1">Zona Alerta</p>
                <p class="text-xl font-bold text-green-700">30-40% ou 60-70%</p>
            </div>
            <div class="p-4 bg-red-100/30 border border-red-200/60 rounded-[10px]">
                <p class="text-xs font-700 text-red-900 uppercase tracking-wider mb-1">Zona Cr√≠tica</p>
                <p class="text-xl font-bold text-green-700">&lt;30% ou &gt;70%</p>
            </div>
        </div>
    </div>
</div>

<!-- Recommendations & Conditions -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Smart Recommendations -->
    <div class="card bg-gradient-to-br from-emerald-50 to-white border border-emerald-100 hover:shadow-lg transition-all duration-500">
        <h3 class="text-lg font-semibold text-gray-900 mb-5 flex items-center gap-2">
            <i class="icon-lightbulb text-emerald-600"></i>
            A√ß√µes Recomendadas
        </h3>
        <div id="recommendationsList" class="space-y-2">
            <div class="p-3 bg-gray-50 rounded-lg text-center text-sm text-gray-600">Carregando recomenda√ß√µes...</div>
        </div>
    </div>

    <!-- Soil Conditions Analysis -->
    <div class="card bg-gradient-to-br from-cyan-50 to-white border border-cyan-100 hover:shadow-lg transition-all duration-500">
        <h3 class="text-lg font-semibold text-gray-900 mb-5 flex items-center gap-2">
            <i class="icon-layers text-cyan-600"></i>
            Condi√ß√µes do Solo
        </h3>
        <div id="soilConditionsList" class="space-y-2">
            <div class="p-3 bg-gray-50 rounded-lg text-center text-sm text-gray-600">Analisando condi√ß√µes...</div>
        </div>
    </div>
</div>

<!-- Latest Readings Table -->
<div class="card bg-white hover:shadow-lg transition-all duration-500">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 pb-6 border-b border-gray-100">
        <div>
            <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                <i class="icon-table text-amber-600"></i>
                Hist√≥rico de Leituras
            </h3>
            <p class="text-sm text-gray-500 mt-1">√öltimas 15 medi√ß√µes do sensor</p>
        </div>
        <button onclick="refreshSoloData()" class="btn btn-sm btn-secondary hover:bg-amber-50 transition-all duration-300">
            <i class="icon-refresh-cw"></i>
            <span class="hidden sm:inline">Atualizar</span>
        </button>
    </div>
    
    <div class="overflow-x-auto -mx-6 sm:mx-0">
        <table class="w-full text-sm">
            <thead>
                <tr class="border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white">
                    <th class="text-left py-3 px-6 font-600 text-gray-700">Humidade</th>
                    <th class="text-left py-3 px-6 font-600 text-gray-700">Status</th>
                    <th class="text-left py-3 px-6 font-600 text-gray-700">Recomenda√ß√£o</th>
                    <th class="text-left py-3 px-6 font-600 text-gray-700">Temperatura</th>
                    <th class="text-left py-3 px-6 font-600 text-gray-700">Hora</th>
                </tr>
            </thead>
            <tbody id="soilTableBody">
                <tr>
                    <td colspan="5" class="text-center py-12 text-gray-500">
                        <div class="spinner mx-auto mb-3"></div>
                        <p>A carregar dados...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    const soloState = {
        charts: {},
        refreshInterval: null,
        isVisible: true,
        data: []
    };
    
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#6B7280';
    
    function initCharts() {
        const ctx = document.getElementById('soilChart');
        if (!ctx) return;
        
        soloState.charts.soil = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Humidade do Solo (%)',
                    data: [],
                    borderColor: 'rgb(217, 119, 6)',
                    backgroundColor: 'rgba(217, 119, 6, 0.08)',
                    tension: 0.6,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 7,
                    pointBackgroundColor: 'rgb(217, 119, 6)',
                    pointBorderColor: 'white',
                    pointBorderWidth: 2.5,
                    borderWidth: 3.5,
                    clip: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.85)',
                        padding: 14,
                        titleFont: { size: 13, weight: '600' },
                        bodyFont: { size: 12, weight: '500' },
                        borderColor: 'rgba(255, 255, 255, 0.15)',
                        borderWidth: 1,
                        displayColors: false,
                        titleMarginBottom: 8,
                        callbacks: {
                            label: function(context) {
                                return 'Humidade: ' + context.parsed.y.toFixed(1) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            font: { size: 11, weight: '500' },
                            callback: function(value) { return value + '%'; },
                            padding: 12
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.04)',
                            drawBorder: false,
                            lineWidth: 1.5
                        }
                    },
                    x: {
                        ticks: { font: { size: 11, weight: '500' }, padding: 8 },
                        grid: { display: false, drawBorder: false }
                    }
                }
            }
        });
    }
    
    function getSoilStatus(humidity) {
        if (humidity < 30) return { 
            status: 'Cr√≠tico - Seco', 
            action: 'Regar imediatamente', 
            color: 'danger',
            level: 'Cr√≠tico',
            risk: 'Alto'
        };
        if (humidity < 40) return { 
            status: 'Aten√ß√£o - Seco', 
            action: 'Regar em breve', 
            color: 'warning',
            level: 'Aviso',
            risk: 'Moderado'
        };
        if (humidity <= 60) return { 
            status: '√ìtimo', 
            action: 'Manter condi√ß√£o atual', 
            color: 'success',
            level: 'Ideal',
            risk: 'Baixo'
        };
        if (humidity <= 70) return { 
            status: 'Aten√ß√£o - H√∫mido', 
            action: 'Melhorar drenagem', 
            color: 'warning',
            level: 'Aviso',
            risk: 'Moderado'
        };
        return { 
            status: 'Cr√≠tico - Encharcado', 
            action: 'Melhorar drenagem urgentemente', 
            color: 'danger',
            level: 'Cr√≠tico',
            risk: 'Alto'
        };
    }

    function calculateHealthScore(humidity) {
        if (humidity >= 40 && humidity <= 60) {
            return Math.round(100 - Math.abs(50 - humidity) / 10 * 5);
        }
        if (humidity >= 30 && humidity < 40) {
            return Math.round(70 - (40 - humidity) * 3);
        }
        if (humidity > 60 && humidity <= 70) {
            return Math.round(70 - (humidity - 60) * 3);
        }
        if (humidity < 30 || humidity > 70) {
            return Math.round(Math.max(20, 100 - Math.abs(50 - humidity) * 2));
        }
        return 50;
    }

    function getRecommendations(humidity) {
        const recs = [];
        if (humidity < 30) {
            recs.push('üö® Irrigar imediatamente');
            recs.push('üíß Aumentar frequ√™ncia de rega para 3-4x por dia');
            recs.push('üìä Monitoramento cont√≠nuo');
        } else if (humidity < 40) {
            recs.push('‚ö†Ô∏è Solo muito seco - Rega necess√°ria');
            recs.push('üíß Aumentar rega para 2x ao dia');
            recs.push('üåç Aplicar mulch para reter umidade');
        } else if (humidity <= 60) {
            recs.push('‚úÖ Condi√ß√µes √≥timas mantidas');
            recs.push('üå± Continuar programa de rega');
            recs.push('üìà Monitoramento padr√£o');
        } else if (humidity <= 70) {
            recs.push('‚ö†Ô∏è Solo ligeiramente √∫mido');
            recs.push('üí® Melhorar ventila√ß√£o/drenagem');
            recs.push('üìâ Reduzir frequ√™ncia de rega');
        } else {
            recs.push('üö® Solo muito encharcado');
            recs.push('üí® Melhorar drenagem urgentemente');
            recs.push('üåø T√©cnicas de drenagem avan√ßadas');
        }
        return recs;
    }

    function getSoilConditions(humidity, data) {
        const conditions = [];
        const latest = data[0];
        const temp = latest.bme280?.temperatura || 0;
        
        conditions.push({
            label: 'Compacta√ß√£o',
            value: humidity < 40 ? 'Alta' : (humidity > 70 ? 'Normal' : 'Normal'),
            color: humidity < 40 ? 'text-red-600' : 'text-green-600'
        });
        
        conditions.push({
            label: 'Temperatura',
            value: temp > 30 ? 'Quente' : (temp < 10 ? 'Fria' : 'Ideal'),
            color: temp > 30 ? 'text-orange-600' : (temp < 10 ? 'text-blue-600' : 'text-green-600')
        });
        
        conditions.push({
            label: 'Aera√ß√£o',
            value: humidity < 60 ? 'Boa' : 'Reduzida',
            color: humidity < 60 ? 'text-green-600' : 'text-yellow-600'
        });
        
        return conditions;
    }
    
    function updateKPIs(data) {
        if (!data || data.length === 0) return;
        
        const latest = data[0];
        const humidity = latest.solo?.humidade;
        
        if (humidity != null) {
            document.getElementById('soilValue').textContent = formatHumidity(humidity);
            const status = getSoilStatus(humidity);
            document.getElementById('soilRecommendation').textContent = status.status;
            document.getElementById('soilAction').textContent = `Recomenda√ß√£o: ${status.action}`;
            document.getElementById('humidityLevel').textContent = status.level;
            
            const badgeEl = document.getElementById('statusBadge');
            badgeEl.innerHTML = `<span class="badge badge-${status.color}">${status.status}</span>`;
            
            const healthScore = calculateHealthScore(humidity);
            document.getElementById('healthScore').textContent = healthScore;
            document.getElementById('healthBar').style.width = healthScore + '%';
            document.getElementById('healthStatus').textContent = healthScore > 75 ? '‚úÖ Excelente' : healthScore > 50 ? '‚ö†Ô∏è Aceit√°vel' : 'üö® Necessita interven√ß√£o';
            
            document.getElementById('riskLevel').textContent = status.risk;
            document.getElementById('riskDescription').textContent = getRecommendations(humidity)[0];
            const riskBadge = document.getElementById('riskBadge');
            riskBadge.innerHTML = `<span class="badge badge-${status.color}">${status.risk}</span>`;
            
            const humidities = data.map(d => d.solo?.humidade).filter(h => h != null);
            const soilMin = Math.min(...humidities);
            document.getElementById('soilMin').textContent = soilMin.toFixed(1) + '%';
        }
    }
    
    function updateCharts(data) {
        if (!data || data.length === 0) return;
        
        const recentData = data.slice(0, 24).reverse();
        const labels = recentData.map(d => formatTime(d.timestamp));
        const soil = recentData.map(d => d.solo?.humidade || null);
        
        if (soloState.charts.soil) {
            soloState.charts.soil.data.labels = labels;
            soloState.charts.soil.data.datasets[0].data = soil;
            soloState.charts.soil.update('none');
        }

        const humidities = data.map(d => d.solo?.humidade).filter(h => h != null);
        const avg = humidities.reduce((a, b) => a + b, 0) / humidities.length;
        const variation = Math.max(...humidities) - Math.min(...humidities);
        
        document.getElementById('avgHumidity').textContent = avg.toFixed(1) + '%';
        document.getElementById('variationHumidity').textContent = variation.toFixed(1) + '%';
    }
    
    function updateRecommendations(humidity) {
        const recommendations = getRecommendations(humidity);
        const list = document.getElementById('recommendationsList');
        
        list.innerHTML = recommendations.map((rec) => {
            const [icon, text] = rec.split(' ');
            return `
                <div class="p-3 bg-white border border-emerald-100/50 rounded-lg hover:border-emerald-200 hover:shadow-sm transition-all duration-300 cursor-pointer">
                    <p class="text-sm text-gray-800 font-500"><span class="text-lg mr-2">${icon}</span>${text}</p>
                </div>
            `;
        }).join('');
    }

    function updateSoilConditions(humidity, data) {
        const conditions = getSoilConditions(humidity, data);
        const list = document.getElementById('soilConditionsList');
        
        list.innerHTML = conditions.map(cond => `
            <div class="p-3 bg-white border border-cyan-100/50 rounded-lg flex items-center justify-between hover:border-cyan-200 hover:shadow-sm transition-all duration-300">
                <span class="text-sm font-600 text-gray-700">${cond.label}</span>
                <span class="text-sm font-bold ${cond.color}">${cond.value}</span>
            </div>
        `).join('');
    }
    
    function updateTable(data) {
        if (!data || data.length === 0) return;
        
        const tbody = document.getElementById('soilTableBody');
        const rows = data.slice(0, 15).map(item => {
            const humidity = item.solo?.humidade;
            const temperature = item.bme280?.temperatura;
            const time = new Date(item.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const status = getSoilStatus(humidity);
            
            return `
                <tr class="border-b border-gray-100 hover:bg-amber-50/50 transition-colors duration-200">
                    <td class="py-3 px-6 font-bold text-amber-600">${formatHumidity(humidity)}</td>
                    <td class="py-3 px-6"><span class="badge badge-${status.color}">${status.status}</span></td>
                    <td class="py-3 px-6 text-sm text-gray-700">${status.action}</td>
                    <td class="py-3 px-6 text-sm text-gray-600">${temperature ? formatTemperature(temperature) : '-'}</td>
                    <td class="py-3 px-6 text-sm text-gray-600 font-500">${time}</td>
                </tr>
            `;
        }).join('');
        
        tbody.innerHTML = rows || '<tr><td colspan="5" class="text-center py-8 text-gray-500">Sem dados dispon√≠veis</td></tr>';
    }
    
    async function fetchSoloData() {
        try {
            const response = await API.getAllData();
            if (!response.ok) throw new Error('Failed to fetch solo data');
            
            const data = await response.json();
            if (Array.isArray(data) && data.length > 0) {
                soloState.data = data;
                const humidity = data[0].solo?.humidade;
                
                updateKPIs(data);
                updateCharts(data);
                if (humidity != null) {
                    updateRecommendations(humidity);
                    updateSoilConditions(humidity, data);
                }
                updateTable(data);
                console.log('[Solo] Data updated successfully');
            }
        } catch (error) {
            console.error('Error fetching solo data:', error);
            showError('Erro ao carregar dados do solo');
        }
    }
    
    async function refreshSoloData() {
        showInfo('A atualizar dados do solo...');
        await fetchSoloData();
    }
    
    function setupAutoRefresh() {
        if (soloState.refreshInterval) {
            clearInterval(soloState.refreshInterval);
        }
        
        soloState.refreshInterval = setInterval(() => {
            if (soloState.isVisible && document.visibilityState === 'visible') {
                fetchSoloData();
            }
        }, 60000);
    }
    
    document.addEventListener('visibilitychange', () => {
        soloState.isVisible = !document.hidden;
        if (soloState.isVisible) {
            fetchSoloData();
        }
    });
    
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('[Solo] Initializing...');
        initCharts();
        await fetchSoloData();
        setupAutoRefresh();
    });
    
    window.addEventListener('beforeunload', () => {
        if (soloState.refreshInterval) {
            clearInterval(soloState.refreshInterval);
        }
        Object.values(soloState.charts).forEach(chart => {
            if (chart) {
                try {
                    chart.destroy();
                } catch (e) {
                    console.warn('Error destroying chart:', e);
                }
            }
        });
    });
</script>
{% endblock %}
