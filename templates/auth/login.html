{% extends "base_auth.html" %}

{% block title %}Login - AgroCaua{% endblock %}

{% block content %}
<form id="loginForm" class="space-y-6">
    <div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Entrar</h2>
        <p class="text-sm text-gray-500">Aceda à sua conta AgroCaua</p>
    </div>
    
    <!-- Email Field -->
    <div>
        <label for="email" class="form-label">Email</label>
        <input 
            type="email" 
            id="email" 
            name="email" 
            required 
            class="form-input"
            placeholder="seu@email.com"
        >
    </div>
    
    <!-- Password Field -->
    <div>
        <label for="password" class="form-label">Senha</label>
        <input 
            type="password" 
            id="password" 
            name="password" 
            required 
            class="form-input"
            placeholder="••••••••"
        >
    </div>
    
    <!-- Submit Button -->
    <button 
        type="submit" 
        id="submitBtn"
        class="btn btn-primary w-full justify-center"
    >
        <span id="btnText">Aceder como Agricultor</span>
        <div id="btnSpinner" class="spinner hidden"></div>
    </button>
    
    <!-- Register Link -->
    <div class="text-center text-sm">
        <span class="text-gray-500">Ainda não tens conta?</span>
        <a href="/register" class="text-green-600 hover:text-green-700 font-semibold ml-1">
            Criar Conta
        </a>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
    const loginForm = document.getElementById('loginForm');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        // Show loading state
        submitBtn.disabled = true;
        btnText.classList.add('hidden');
        btnSpinner.classList.remove('hidden');
        
        try {
            const response = await API.login(email, password);
            const data = await response.json();
            
            if (response.ok) {
                // Save token
                saveToken(data.token);
                
                // Show success message
                showSuccess('Login realizado com sucesso!');
                
                // Redirect to dashboard
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1000);
            } else {
                // Show error message
                showError(data.erro || 'Credenciais inválidas');
                
                // Reset button
                submitBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        } catch (error) {
            console.error('Login error:', error);
            showError('Erro ao fazer login. Tente novamente.');
            
            // Reset button
            submitBtn.disabled = false;
            btnText.classList.remove('hidden');
            btnSpinner.classList.add('hidden');
        }
    });
    
    // Clear token on page load (fresh login)
    clearToken();
</script>
{% endblock %}
